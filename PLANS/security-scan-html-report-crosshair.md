# Security Scan HTML Report: Crosshair / Cursor

## Request
Add a "crosshair" you can drag back and forth in the HTML report generated by `src/backend/app/security_scan/` to make relationships easier to see. Determine whether this is possible in a single self-contained HTML file, and propose a plan.

## Current State (What The Code Actually Does)
- The HTML report is generated as a single static HTML string in `src/backend/app/security_scan/reporting/html_report.py` (`render_html_report`).
  - Markdown is rendered to HTML using `markdown_it` and inlined into a `<article class="report">`.
  - Styling is inline `<style>...</style>`; there are currently no custom `<script>` blocks added by this module.
- Aggregate charts are optional and are injected as already-built HTML (`charts_html`) immediately after the first `<h1>` in the rendered body.
  - Charts HTML comes from Plotly via `src/backend/app/security_scan/reporting/aggregate_charts.py` (`plotly.io.to_html(... include_plotlyjs="inline" ...)` for the first chart).
  - Output is still a single `.html` file (the Plotly JS bundle is embedded inline, so the report is fully offline/self-contained).

## Assessment: Is This Possible In A Single HTML File?
Yes.

A crosshair/cursor is purely client-side behavior (CSS + JavaScript). Since the report is already a self-contained HTML artifact (including Plotly JS inline for the charts), we can safely add:
- inline CSS for visuals, and
- inline JS that attaches event handlers to tables and/or Plotly charts

…without requiring additional files, build tooling, or network access.

## Clarify The "Crosshair" (Two Plausible Meanings)
The report has two main "dense" areas where a crosshair could help:

1. **Plotly timeseries charts**
   - Desired behavior usually means: a vertical cursor line that follows the pointer (or is pinned) so you can compare values at the same date across multiple series.
   - In this case, the ask is specifically about “relationships” across the stacked chart blocks, which likely means syncing that cursor across multiple Plotly figures (currently groups of 3).

2. **Large HTML tables (markdown-rendered)**
   - Desired behavior usually means: highlight the current row *and* the current column (Excel-like crosshair) to follow a metric across columns without losing your place.

3. However, the requirement is only for the html report, not the markdown report.

Because your question says “drag back and forth,” I suspect you mean the chart cursor (timeseries), but this should be confirmed. Actually, this means that the crosshair should be moveable by cursor.

## Options (Ordered By Blast Radius / Complexity)

### Option A (Recommended First): Plotly Built-In Crosshair Within Each Chart
**What you get**
- A vertical cursor line and unified hover readout for a single chart block (including its 3 stacked subplots).
- You can move the mouse left/right to scan dates; no custom JS required.

**How**
- In `src/backend/app/security_scan/reporting/aggregate_charts.py` inside `build_timeseries_figure`:
  - set `hovermode="x unified"` (or `"x"`) so hover compares series at the same x-date.
  - enable x-axis spikelines (`showspikes`, `spikemode="across"`, `spikesnap="cursor"`, etc.)

**Pros**
- Minimal change surface (one Python function).
- Least brittle (no dependence on Plotly internal JS APIs).
- Still outputs a single static HTML file.

**Cons**
- Cursor is per-chart-block; it does not automatically sync to other chart blocks.

### Option B: Sync The Cursor Across All Plotly Chart Blocks On The Page
**What you get**
- Hover (or click-drag) on any chart: the same date is highlighted across all charts, making cross-chart relationships obvious.
- Optional “pin cursor” behavior (click to lock; drag to move; click again to release).

**How**
- Combine Option A (to make each chart crosshair-friendly) with a small inline JS snippet injected by `src/backend/app/security_scan/reporting/html_report.py`.
- JS:
  - finds all `.plotly-graph-div` elements within the `.charts` section
  - listens for `plotly_hover` events and propagates the hovered x-value to other charts

**Implementation note (important)**
There are 2 viable propagation mechanisms:
- `Plotly.Fx.hover(...)` on sibling charts (simpler, but somewhat dependent on Plotly API stability), or
- add a dedicated “cursor” `layout.shape` to each figure and update it via `Plotly.relayout(...)` (more code, but less magical and easier to reason about).

**Pros**
- Best relationship-visibility outcome.
- Still self-contained; no build tooling.

**Cons / Risks**
- More moving parts and more “density” (JS event syncing can create feedback loops; must guard with a `syncInProgress` flag).
- Needs careful handling for charts with different x-domain coverage (some days missing). Expected behavior should be defined (snap to nearest date vs do nothing).

### Option C: Table Row+Column Highlight Crosshair
**What you get**
- While hovering over a cell, highlight its row and column.
- Great for reading “wide” tables (metric comparisons).

**How**
- Inline JS in `html_report.py` using event delegation on `table` elements:
  - on `mouseover`, determine cell index and add a CSS class to all cells in that column + the row
  - on `mouseout`, clear highlights
  - optional click-to-pin

**Pros**
- Very small code, high usability on the tables-heavy portion of the report.

**Cons**
- Not directly about timeseries “relationships.”

## Recommendation
1. Implement **Option A** first (built-in Plotly crosshair per chart). It is the lowest blast radius and will likely satisfy the “drag back and forth” intent for most use cases.
2. If you specifically want to compare *across* chart blocks at the same date (Advance% vs ROC breadth vs MA breadth), add **Option B** (linked cursor).
3. If your pain is primarily reading wide tables, add **Option C** (table crosshair). It’s independent and can be done even if charts are disabled.

## Concrete Plan (If You Want Me To Implement)

### Phase 1: Per-Chart Crosshair (Plotly)
1. Update `src/backend/app/security_scan/reporting/aggregate_charts.py`:
   - in `build_timeseries_figure`, set:
     - `figure.update_layout(hovermode="x unified")`
     - `figure.update_xaxes(showspikes=True, spikemode="across", spikesnap="cursor", spikethickness=1, spikecolor="rgba(15, 23, 42, 0.65)")`
     - optionally `figure.update_layout(hoverdistance=5, spikedistance=-1)` (exact values may need quick manual tuning)
2. Generate a report via `uv run security-scan` and validate in a browser:
   - moving pointer left/right shows a clear vertical cursor line
   - hover readout compares series at same x-date
   - no JS console errors (should be none; this is Plotly-native)

### Phase 2 (Optional): Linked Crosshair Across Charts
1. Update `src/backend/app/security_scan/reporting/html_report.py` to append a small `<script>` at the end of `<body>`:
   - if `window.Plotly` is missing or there are <2 charts, do nothing
   - add a single “Link charts” toggle UI (or default-on with a `data-*` flag)
2. Implement hover syncing with safeguards:
   - `let syncInProgress = false;`
   - on `plotly_hover`, if not syncing:
     - read `x = evt.points?.[0]?.x`
     - propagate to other charts
   - on `plotly_unhover`, unhover others unless cursor is pinned
3. Validate:
   - hover on chart A shows same date cursor/tooltip on charts B..N
   - fast mouse movement doesn’t lock up the page

### Phase 3 (Optional): Table Crosshair
1. Update `src/backend/app/security_scan/reporting/html_report.py`:
   - add CSS classes for `.table-crosshair-row` and `.table-crosshair-col`
   - add JS that toggles those classes via event delegation
2. Validate:
   - row+column highlighting works on all markdown-rendered tables
   - performance is fine (tables are not huge)

## Open Questions (To Avoid Building The Wrong Thing)
1. Is your “crosshair” request aimed at the **Plotly charts**, the **tables**, or both?
2. If charts: do you want the cursor to be **linked across chart blocks**, or is per-chart enough?
3. Should the cursor be **hover-only**, or **click-to-pin + drag-to-move**?

